<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI交互测试 - 直接使用图片链接版</title>
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 保留所有原有样式，此处省略（样式无修改） */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
            --warning-color: #ff9800;
            --danger-color: #f72585;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #2d3748;
            --text-light: #718096;
            --border-color: #e2e8f0;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --transition-normal: 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            margin: 0;
            padding: 20px 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
        }

        .decor-element {
            position: fixed;
            border-radius: 50%;
            background: rgba(67, 97, 238, 0.08);
            z-index: -1;
            animation: float 15s ease-in-out infinite;
        }

        .decor-1 {
            width: 200px;
            height: 200px;
            top: 20%;
            left: 5%;
            animation-delay: 0s;
        }

        .decor-2 {
            width: 250px;
            height: 250px;
            bottom: 20%;
            right: 5%;
            animation-delay: 5s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
            }
            50% {
                transform: translateY(-25px) translateX(15px);
            }
        }

        .container {
            width: 95%;
            max-width: 1400px;
            min-height: 70vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-direction: row;
            text-align: center;
            margin: 0 auto;
            gap: 20px;
        }

        .left {
            width: 30%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            text-align: left;
            background-color: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            box-sizing: border-box;
            transition: var(--transition-normal);
        }

        .left:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }

        .right {
            width: 20%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            text-align: left;
            background-color: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            box-sizing: border-box;
            position: relative;
            transition: var(--transition-normal);
        }

        .right:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }

        .middle {
            width: 45%;
            text-align: center;
            background-color: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-md);
            box-sizing: border-box;
            transition: var(--transition-normal);
        }

        .middle:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }

        .home-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 9px 18px;
            background: linear-gradient(90deg, var(--danger-color), #e53e3e);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition-normal);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 8px rgba(247, 37, 133, 0.2);
        }

        .home-btn i {
            font-size: 16px;
        }

        .home-btn:hover {
            background: linear-gradient(90deg, #e53e3e, var(--danger-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(247, 37, 133, 0.3);
        }

        .undo-btn {
            padding: 12px 24px;
            background: linear-gradient(90deg, var(--warning-color), #f57c00);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            align-self: flex-start;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 8px rgba(255, 152, 0, 0.2);
        }

        .undo-btn i {
            font-size: 18px;
        }

        .undo-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .undo-btn:hover:not(:disabled) {
            background: linear-gradient(90deg, #f57c00, var(--warning-color));
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(255, 152, 0, 0.3);
        }

        .text-box {
            box-sizing: border-box;
            width: 100%;
            margin: 0 0 25px 0;
            padding: 14px;
            font-size: 18px;
            text-align: center;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
            background-color: var(--bg-light);
            color: var(--text-dark);
            font-weight: 600;
            transition: var(--transition-normal);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .text-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05), 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .left table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            table-layout: auto;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .left th, .left td {
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 12px 15px;
            text-align: left;
            white-space: normal;
            word-wrap: break-word;
            transition: var(--transition-normal);
        }

        .left tr:last-child th,
        .left tr:last-child td {
            border-bottom: 1px solid var(--border-color);
        }

        .left th:first-child,
        .left td:first-child {
            width: 20%;
            font-weight: 600;
            background-color: rgba(67, 97, 238, 0.05);
        }

        .left th:last-child,
        .left td:last-child {
            width: 80%;
        }

        .left th {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .left tr:hover td {
            background-color: #f0f5ff;
            transform: translateX(3px);
        }

        .undo-history {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--bg-light);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--warning-color);
            box-shadow: var(--shadow-sm);
        }

        .undo-history h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .undo-history h4 i {
            color: var(--warning-color);
        }

        .undo-history p {
            margin: 6px 0;
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.6;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .undo-history p:last-child {
            border-bottom: none;
        }

        .undo-history .empty {
            color: var(--text-light);
            font-style: italic;
            padding: 8px 0;
        }

        .annotation-count {
            margin-top: 15px;
            padding: 12px 15px;
            background: linear-gradient(90deg, rgba(67, 97, 238, 0.1), rgba(67, 97, 238, 0.05));
            border-radius: var(--radius-md);
            font-size: 15px;
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .annotation-count span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .annotation-count i {
            font-size: 16px;
        }

        .image-container {
            border: 2px solid var(--primary-color);
            padding: 20px;
            display: inline-block;
            margin-bottom: 25px;
            border-radius: var(--radius-md);
            background-color: var(--bg-light);
            transition: var(--transition-normal);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .image-container:hover {
            border-color: var(--accent-color);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .middle img {
            width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: var(--radius-sm);
            cursor: crosshair;
            transition: var(--transition-normal);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .middle img:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .end-btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: var(--transition-normal);
            margin-top: 20px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            margin-left: 0;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .end-btn i {
            font-size: 20px;
        }

        .end-btn:hover {
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
        }

        .end-btn:active {
            transform: translateY(0);
        }

        .right h3 {
            margin: 0 0 20px 0;
            font-size: 22px;
            color: var(--primary-color);
            padding-top: 5px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .right h3 i {
            font-size: 20px;
        }

        .right p {
            font-size: 16px;
            color: var(--text-light);
            line-height: 1.8;
            margin: 10px 0;
            padding-left: 5px;
        }

        .important-text {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-dark);
            margin: 18px 0;
            padding-left: 32px;
            position: relative;
            line-height: 1.6;
        }

        .important-text::before {
            content: '✓';
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--success-color);
            font-weight: bold;
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .important-text-red {
            font-size: 17px;
            font-weight: 600;
            color: var(--danger-color) !important;
            margin: 18px 0;
            padding-left: 32px;
            position: relative;
            line-height: 1.6;
        }

        .important-text-red::before {
            content: '!';
            position: absolute;
            left: 0;
            top: 2px;
            background: var(--danger-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin: 0 0 25px 0;
            text-align: center;
            width: 100%;
            position: relative;
            padding-bottom: 15px;
        }

        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .feedback-toast {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            padding: 14px 28px;
            background-color: rgba(76, 175, 80, 0.95);
            color: white;
            border-radius: 30px;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feedback-toast i {
            font-size: 18px;
        }

        .feedback-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .feedback-toast.error {
            background-color: rgba(247, 37, 133, 0.95);
        }

        .feedback-toast.undo {
            background-color: rgba(255, 152, 0, 0.95);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            flex-direction: column;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--bg-light);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes undoPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .undo-animation {
            animation: undoPulse 0.5s ease;
        }

        #imageError {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            cursor: pointer;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .left, .middle, .right {
                width: 90%;
                max-width: 600px;
                margin-bottom: 15px;
            }
            .middle img {
                max-height: 50vh;
            }
            h1 {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 768px) {
            .annotation-count {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .end-btn {
                width: 100%;
                justify-content: center;
                margin-right: 0;
            }
            .important-text,
            .important-text-red {
                padding-left: 28px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px 0;
            }
            .left, .middle, .right {
                width: 95%;
                padding: 15px;
            }
            .image-container {
                padding: 10px;
            }
            .undo-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container > div {
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
        }

        .left { animation-delay: 0.1s; }
        .middle { animation-delay: 0.2s; }
        .right { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <!-- 装饰元素 -->
    <div class="decor-element decor-1"></div>
    <div class="decor-element decor-2"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p style="font-size: 18px; color: var(--text-dark); font-weight: 500;">加载中，请稍候...</p>
    </div>

    <div class="feedback-toast" id="feedbackToast">
        <i class="fas fa-check-circle"></i>
        <span>操作成功</span>
    </div>

    <div class="container">
        <div class="left">
            <input id="operationType" class="text-box" type="text" value="1/50 - 交互类型" readonly>
            <h3 style="color: var(--text-dark); font-size: 18px; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-book" style="color: var(--primary-color);"></i>
                交互类型说明
            </h3>
            <table>
                <tr>
                    <th>交互类型</th>
                    <th>模拟方式</th>
                </tr>
                <tr>
                    <td>点击</td>
                    <td>在目标区域按一下鼠标左键</td>
                </tr>
                <tr>
                    <td>滑动</td>
                    <td>鼠标左键保持按住状态并拖动</td>
                </tr>
                <tr>
                    <td>拖动</td>
                    <td>同时按下鼠标左键和「D/d」键，移动后释放</td>
                </tr>
                <tr>
                    <td>文本输入</td>
                    <td>同时按下鼠标左键和「T/t」键，文本框内拖动</td>
                </tr>
            </table>
            
            <div class="annotation-count" id="annotationCount">
                <span><i class="fas fa-clipboard-check"></i> 当前标注数：0</span>
                <span><i class="fas fa-undo"></i> 可撤销数：0</span>
            </div>
            
            <button class="undo-btn" id="undoBtn" onclick="undoLastAnnotation()" disabled>
                <i class="fas fa-undo-alt"></i>
                <span>无标注可撤销</span>
            </button>
            
            <div class="undo-history">
                <h4><i class="fas fa-history"></i> 最近撤销记录</h4>
                <div id="undoHistoryContent" class="empty">
                    暂无撤销记录
                </div>
            </div>
        </div>

        <div class="middle">
            <h1>UI交互测试</h1>
            <div class="image-container">
                <img id="taskImage" alt="UI截图加载中..." title="点击/拖动进行交互" loading="lazy">
            </div>
            <p id="imageError" style="color: var(--danger-color); font-weight: 600; display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                图片加载失败，正在重试...
            </p>
        </div>

        <div class="right">
            <button class="home-btn" onclick="goToHome()">
                <i class="fas fa-arrow-left"></i>
                返回首页
            </button>
            
            <h3><i class="fas fa-tasks"></i> 任务说明</h3>
            <p class="important-text" id="currentCategory">当前分类：加载中...</p>
            <p class="important-text" id="currentGroup">当前分组：加载中...</p>
            <p class="important-text" id="imageCountText">共50张UI截图，请完成所有标注</p>
            <button class="end-btn" onclick="endTracking()">
                <i class="fas fa-arrow-right"></i>
                完成当前页
            </button>
        </div>
    </div>

    <span class="js-cursor-container"></span>
    <script src="script/星星拖尾.js"></script>
    <script src="script/点击烟花.js"></script>

    <script>
        // 全局变量定义
        let collectedData = [];
        let annotationHistory = [];
        let taskStartData = [];
        let currentImageIndex = 0;
        let imageUrls = [];
        let allResults = [];
        let nextImage = new Image();
        let currentRetryCount = 0;
        const slideThresholdRatio = 0.04;
        let currentCategory = '';
        let currentGroup = '';
        let classPrefix = ''; // 不再强制设置，通过映射表获取
        let baseImageUrl = '';
        let randomMin = 1;
        let randomMax = 1200;
        let imageCount = 50;
        let totalImageCount = 50;

        // 核心修改：建立分类名称到图片前缀的映射表
        const categoryToPrefixMap = {
            '注册登录': 'class1',
            '编辑检索': 'class2', // 可根据需求添加其他分类的映射
            '属性设置': 'class3',
            '应用功能': 'class4',
            '导航': 'class5'
        };

        // 返回首页函数
        function goToHome() {
            if (confirm('确认返回首页吗？当前测试进度不会保存！')) {
                window.location.href = 'home.html';
            }
        }

        // 格式化时间显示
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return `${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}.${date.getMilliseconds().toString().padStart(3, '0')}`;
        }

        // 更新标注统计
        function updateAnnotationCount() {
            const countElement = document.getElementById('annotationCount');
            countElement.innerHTML = `
                <span><i class="fas fa-clipboard-check"></i> 当前标注数：${collectedData.length}</span>
                <span><i class="fas fa-undo"></i> 可撤销数：${collectedData.length}</span>
            `;
        }

        // 更新撤销历史记录
        function updateUndoHistory() {
            const historyContent = document.getElementById('undoHistoryContent');
            if (annotationHistory.length === 0) {
                historyContent.innerHTML = '<span class="empty">暂无撤销记录</span>';
                return;
            }

            const recentHistory = annotationHistory.slice(-3).reverse();
            let html = '';
            recentHistory.forEach((item, index) => {
                html += `
                <p>
                    <strong>${index + 1}. ${item.action}</strong> 
                    <br>时间：${formatTime(item.startTime)} 
                    <br>时长：${item.duration}ms
                </p>
                `;
            });
            historyContent.innerHTML = html;
        }

        // 撤销上次标注（优化版）
        function undoLastAnnotation() {
            if (collectedData.length === 0) {
                showFeedback('❌ 没有可撤销的标注', 'error');
                const undoBtn = document.getElementById('undoBtn');
                undoBtn.classList.add('undo-animation');
                setTimeout(() => undoBtn.classList.remove('undo-animation'), 500);
                return;
            }

            const undoneItem = collectedData.pop();
            annotationHistory.push(undoneItem);

            showFeedback(`✅ 已撤销：${undoneItem.action}（${formatTime(undoneItem.startTime)}）`, 'undo');
            
            updateUndoButtonState();
            updateAnnotationCount();
            updateUndoHistory();
            
            updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 已撤销${undoneItem.action}`);
            setTimeout(() => {
                updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 交互类型`);
            }, 2000);
        }

        // 更新撤销按钮状态
        function updateUndoButtonState() {
            const undoBtn = document.getElementById('undoBtn');
            undoBtn.disabled = collectedData.length === 0;
            
            if (collectedData.length === 0) {
                undoBtn.innerHTML = '<i class="fas fa-undo-alt"></i><span>无标注可撤销</span>';
            } else {
                undoBtn.innerHTML = `<i class="fas fa-undo-alt"></i><span>撤销上次标注（${collectedData.length}条可撤销）</span>`;
            }
        }

        // 工具函数：更新文本框
        function updateTextBox(text) {
            document.getElementById('operationType').value = text;
        }

        // 工具函数：显示反馈提示（优化版，支持不同类型）
        function showFeedback(message, type = 'success') {
            const toast = document.getElementById('feedbackToast');
            let icon = 'check-circle';
            
            if (type === 'error') {
                icon = 'exclamation-circle';
            } else if (type === 'undo') {
                icon = 'undo-alt';
            }
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            toast.classList.remove('success', 'error', 'undo', 'show');
            
            if (type === 'error') {
                toast.classList.add('error');
            } else if (type === 'undo') {
                toast.classList.add('undo');
            } else {
                toast.classList.add('success');
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 图片加载逻辑：直接使用原始链接，修复undefined错误，优化重试机制
        function loadImage(index) {
            if (index < 0 || index >= imageUrls.length) {
                console.error('图片索引超出范围：', index);
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('imageError').style.display = 'none';
            currentRetryCount = 0;

            const taskImage = document.getElementById('taskImage');
            const imageUrl = imageUrls[index];
            const imageName = imageUrl.split('/').pop();
            const imageCacheKey = `uiTest_${classPrefix}_${imageName}`;
            const cachedUrl = localStorage.getItem(imageCacheKey);
            
            if (cachedUrl === imageUrl) {
                console.log(`使用缓存图片：${imageUrl}`);
            } else {
                localStorage.setItem(imageCacheKey, imageUrl);
            }

            updateTextBox(`${index + 1}/${totalImageCount} - 交互类型`);

            // 超时设置（10秒）
            const timeoutTimer = setTimeout(() => {
                taskImage.onerror({ message: 'Timeout' });
            }, 10000);

            // 加载成功回调
            taskImage.onload = function() {
                clearTimeout(timeoutTimer);
                if (taskImage.complete) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    const timestamp = new Date().getTime();
                    const displayedWidth = taskImage.clientWidth;
                    const displayedHeight = taskImage.clientHeight;
                    const originalWidth = taskImage.naturalWidth;
                    const originalHeight = taskImage.naturalHeight;

                    recordTaskStartData(timestamp, displayedWidth, displayedHeight, originalWidth, originalHeight);
                    preloadNextImage(index + 1);
                    showFeedback('图片加载完成，可开始交互');
                    
                    annotationHistory = [];
                    collectedData = [];
                    updateUndoButtonState();
                    updateAnnotationCount();
                    updateUndoHistory();
                }
            };

            // 优化错误处理：修复undefined错误，区分错误类型，新增手动重试
            taskImage.onerror = function(e) {
                clearTimeout(timeoutTimer);
                currentRetryCount++;
                document.getElementById('imageError').style.display = 'flex';
                
                const errorMsg = e?.message || 'Unknown error';
                const isConnectionError = errorMsg.includes('ERR_CONNECTION_RESET') || errorMsg.includes('net::ERR_') || errorMsg.includes('403');
                const maxRetry = isConnectionError ? 5 : 3;
                const retryDelay = isConnectionError ? 2000 : 1000;
                
                if (currentRetryCount < maxRetry) {
                    console.log(`重试加载（${currentRetryCount}/${maxRetry}）：${imageUrl}，错误类型：${errorMsg}`);
                    const feedbackMsg = isConnectionError ? 
                        `网络连接错误，延长重试（${currentRetryCount}/${maxRetry}）` : 
                        `图片加载失败，正在重试（${currentRetryCount}/${maxRetry}）`;
                    showFeedback(feedbackMsg, 'error');
                    
                    setTimeout(() => {
                        taskImage.src = imageUrl;
                    }, retryDelay);
                } else {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('imageError').innerHTML = '<i class="fas fa-exclamation-triangle"></i> 图片加载失败，点击此处重试';
                    document.getElementById('imageError').onclick = function() {
                        currentRetryCount = 0;
                        loadImage(index);
                    };
                    showFeedback('图片加载失败，点击错误提示可重试', 'error');
                }
            };

            // 初始加载：直接使用原始图片链接
            taskImage.src = imageUrl;
        }

        // 预加载下一张图片：直接使用原始链接
        function preloadNextImage(index) {
            if (index < imageUrls.length) {
                nextImage.src = imageUrls[index];
            }
        }

        // 生成指定范围的不重复随机数
        function getUniqueRandomNumbers(min, max, count) {
            const numbers = new Set();
            const maxPossible = Math.min(count, max - min + 1);
            while (numbers.size < maxPossible) {
                const num = Math.floor(Math.random() * (max - min + 1)) + min;
                numbers.add(num);
            }
            return Array.from(numbers);
        }

        // 构建图片URL列表：直接使用原始链接，移除CORS代理
        function buildImageUrls() {
            imageUrls = [];
            const randomNumbers = getUniqueRandomNumbers(randomMin, randomMax, imageCount);
            // 使用映射后的前缀拼接URL
            randomNumbers.forEach(num => {
                const imageUrl = `${baseImageUrl}/${classPrefix}_${num}.jpg`;
                imageUrls.push(imageUrl);
            });
            totalImageCount = imageUrls.length;
            document.getElementById('imageCountText').textContent = `共${totalImageCount}张UI截图，请完成所有标注`;
            document.getElementById('operationType').value = `1/${totalImageCount} - 交互类型`;
            // 打乱顺序（可选）
            imageUrls = shuffleArray(imageUrls);
            console.log(`已生成${imageUrls.length}张图片URL（随机范围：${randomMin}-${randomMax}，前缀：${classPrefix}）`);
            loadImage(currentImageIndex);
        }

        // 洗牌算法打乱图片顺序
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // 记录图片初始信息
        function recordTaskStartData(timestamp, displayedWidth, displayedHeight, originalWidth, originalHeight) {
            taskStartData = [{
                taskStartTimestamp: timestamp,
                imageDisplayWidth: displayedWidth,
                imageDisplayHeight: displayedHeight,
                imageOriginalWidth: originalWidth,
                imageOriginalHeight: originalHeight,
                slideThreshold: Math.min(displayedWidth * slideThresholdRatio, displayedHeight * slideThresholdRatio)
            }];
        }

        // 记录交互数据（优化：添加统计更新）
        function recordData(actionType, startTime, endTime, startCoords, endCoords) {
            const data = {
                action: actionType,
                startTime: startTime,
                endTime: endTime,
                duration: endTime - startTime,
                startCoords: `${startCoords.x.toFixed(2)}, ${startCoords.y.toFixed(2)}`,
                endCoords: `${endCoords.x.toFixed(2)}, ${endCoords.y.toFixed(2)}`,
                slideThreshold: taskStartData[0]?.slideThreshold.toFixed(2) || '0'
            };
            collectedData.push(data);
            console.log('记录交互：', data);
            showFeedback(`已记录：${actionType}`);
            
            updateUndoButtonState();
            updateAnnotationCount();
            updateUndoHistory();
        }

        // 下载测试结果
        function downloadResults(results) {
            const finalResults = {
                testStartTime: new Date(allResults[0]?.taskStartData[0]?.taskStartTimestamp || Date.now()).toLocaleString(),
                testEndTime: new Date().toLocaleString(),
                category: currentCategory,
                group: currentGroup,
                randomRange: `${randomMin}-${randomMax}`,
                totalImages: results.length,
                dataCount: results.reduce((sum, item) => sum + item.taskData.length, 0),
                results: results
            };

            const dataStr = JSON.stringify(finalResults, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const timestamp = new Date().toISOString().replace(/[-:\.T]/g, '').slice(0, 14);
            a.download = `UI测试_${currentCategory}_分组${currentGroup}_随机${randomMin}-${randomMax}_${timestamp}.json`;
            a.href = url;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showFeedback('测试结果已下载');
        }

        // 初始化交互事件监听
        function initInteractionListeners() {
            const taskImage = document.getElementById('taskImage');
            let trackingStarted = true;
            let startTime = 0;
            let startCoords = { x: 0, y: 0 };
            let endCoords = { x: 0, y: 0 };
            let keyDown = null;

            // 鼠标按下
            taskImage.addEventListener('mousedown', function(e) {
                if (!trackingStarted) return;
                const rect = taskImage.getBoundingClientRect();
                startCoords = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                startTime = new Date().getTime();
                updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 交互中...`);
            });

            // 鼠标移动
            taskImage.addEventListener('mousemove', function(e) {
                if (!trackingStarted || e.buttons !== 1) return;
                const rect = taskImage.getBoundingClientRect();
                endCoords = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            });

            // 鼠标抬起（判断交互类型）
            taskImage.addEventListener('mouseup', function(e) {
                if (!trackingStarted) return;
                const rect = taskImage.getBoundingClientRect();
                endCoords = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                const endTime = new Date().getTime();
                const duration = endTime - startTime;
                const distance = Math.sqrt(
                    Math.pow(endCoords.x - startCoords.x, 2) + 
                    Math.pow(endCoords.y - startCoords.y, 2)
                );
                const slideThreshold = taskStartData[0]?.slideThreshold || 10;

                updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 交互类型`);

                // 点击（短时间+短距离）
                if (duration < 500 && distance < slideThreshold) {
                    recordData('Click', startTime, endTime, startCoords, endCoords);
                    updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 点击`);
                }
                // 拖动（D键或d键+滑动）- 支持大小写
                else if ((keyDown === 'D' || keyDown === 'd') && distance > slideThreshold) {
                    recordData('Drag', startTime, endTime, startCoords, endCoords);
                    updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 拖动`);
                }
                // 文本输入（T键或t键+滑动）- 支持大小写
                else if ((keyDown === 'T' || keyDown === 't') && distance > slideThreshold) {
                    recordData('文本输入', startTime, endTime, startCoords, endCoords);
                    updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 文本输入`);
                }
                // 滑动（无按键+长距离）
                else if (distance > slideThreshold) {
                    recordData('Swipe', startTime, endTime, startCoords, endCoords);
                    updateTextBox(`${currentImageIndex + 1}/${totalImageCount} - 滑动`);
                }
                // 无效交互
                else {
                    showFeedback('未识别到有效交互，请重新操作', 'error');
                }
                // 重置按键状态
                keyDown = null;
            });

            // 键盘事件 - 支持大小写T和D
            document.addEventListener('keydown', e => {
                if (e.key === 'D' || e.key === 'd' || e.key === 'T' || e.key === 't') {
                    keyDown = e.key;
                }
            });
            
            // 键盘抬起 - 清除按键状态
            document.addEventListener('keyup', e => {
                if (e.key === 'D' || e.key === 'd' || e.key === 'T' || e.key === 't') {
                    keyDown = null;
                }
            });

            // 禁止图片拖动默认行为
            taskImage.addEventListener('dragstart', e => e.preventDefault());

            // 暴露跟踪控制方法
            window.stopTracking = () => trackingStarted = false;
            window.startTracking = () => trackingStarted = true;
        }

        // 结束当前图片测试
        function endTracking() {
            window.stopTracking();

            // 记录当前图片结果
            const taskImage = document.getElementById('taskImage');
            const imageName = taskImage.src.split('/').pop();
            allResults.push({
                imageIndex: currentImageIndex + 1,
                imageName: imageName,
                taskType: currentCategory,
                taskData: [...collectedData],
                taskStartData: [...taskStartData]
            });

            // 重置当前图片数据
            collectedData = [];
            taskStartData = [];
            annotationHistory = [];
            updateUndoButtonState();
            updateAnnotationCount();
            updateUndoHistory();

            // 下一张或结束
            currentImageIndex++;
            if (currentImageIndex < imageUrls.length) {
                showFeedback(`已完成第${currentImageIndex}张，加载下一张...`);
                loadImage(currentImageIndex);
                setTimeout(window.startTracking, 500);
            } else {
                downloadResults(allResults);
                showFeedback('当前分组测试完成，即将返回分组选择页');
                setTimeout(() => {
                    window.location.href = `category.html?category=${currentCategory}`;
                }, 2000);
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取URL参数（适配新的参数名）
            const params = new URLSearchParams(window.location.search);
            currentCategory = params.get('category') || '未知分类';
            currentGroup = params.get('group') || '未知分组';
            // 核心修改：从映射表获取前缀，兼容classPrefix参数，默认值为class1
            classPrefix = params.get('classPrefix') || categoryToPrefixMap[currentCategory] || 'class1';
            baseImageUrl = params.get('baseUrl') || 'https://class1-7sbns0vg.maozi.io/src';
            randomMin = parseInt(params.get('randomMin')) || 1;
            randomMax = parseInt(params.get('randomMax')) || 1200;
            imageCount = parseInt(params.get('imageCount')) || 50;

            // 显示分类和分组信息
            document.getElementById('currentCategory').textContent = `当前分类：${currentCategory}`;
            document.getElementById('currentGroup').textContent = `当前分组：${currentGroup}（随机范围：${randomMin}-${randomMax}，前缀：${classPrefix}）`;

            // 初始化界面状态
            updateUndoButtonState();
            updateAnnotationCount();
            updateUndoHistory();
            
            // 初始化
            initInteractionListeners();
            buildImageUrls();

            // 禁止后退
            history.pushState(null, null, document.URL);
            window.addEventListener('popstate', () => {
                history.pushState(null, null, document.URL);
                showFeedback('测试中不支持后退，请完成当前流程', 'error');
            });
        });
    </script>
</body>
</html>
